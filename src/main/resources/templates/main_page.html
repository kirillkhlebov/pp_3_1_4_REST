<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <title>Hello, world!</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }
    </style>
</head>
<body class="bg-light">
<header class="bd-header bg-dark py-3 d-flex align-items-stretch border-bottom border-dark">
    <div class="container-fluid d-flex align-items-center">
        <h1 class="d-flex align-items-center fs-4 text-white mb-0 mx-2">
            Logged user:&nbsp<span sec:authentication="name"></span>
        </h1>
        <div class="fw-normal text-white my-2">
            with roles: <span sec:authentication="principal.authorities"></span>
        </div>
        <div class="ms-auto">
            <form th:action="@{/logout}" th:method="POST">
                <input type="submit" class="btn btn-outline-secondary" value="Logout">
            </form>
        </div>
    </div>
</header>
<div class="d-flex align-items-start h-100">
    <div class="d-flex flex-column h-100 bg-white col-2">
        <div class="flex-grow-1">
            <div class="nav flex-column nav-pills w-100" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="flex-sm-fill text-sm-center nav-link active my-2 mx-2" id="v-pills-profile-tab"
                        data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab"
                        aria-controls="v-pills-profile" aria-selected="false">User
                </button>
                <button class="flex-sm-fill text-sm-center nav-link my-2 mx-2" sec:authorize="hasRole('ROLE_ADMIN')"
                        id="v-pills-home-tab"
                        data-bs-toggle="pill" data-bs-target="#v-pills-home" type="button" role="tab"
                        aria-controls="v-pills-home" aria-selected="true">Admin
                </button>
            </div>
        </div>
    </div>
    <div class="col-10">
        <div class="tab-content" id="v-pills-tabContent">
            <!-- Admin panel content -->
            <div class="tab-pane fade mx-2 my-2" sec:authorize="hasRole('ROLE_ADMIN')" id="v-pills-home" role="tabpanel"
                 aria-labelledby="v-pills-home-tab">
                <h2 class="mx-2 my-2">
                    Admin panel
                </h2>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="home-tab" data-bs-toggle="tab"
                                data-bs-target="#home"
                                type="button" role="tab" aria-controls="home" aria-selected="true">Users table
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">

                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile"
                                type="button" role="tab" aria-controls="profile" aria-selected="false">New User
                        </button>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div class="tab-pane active" id="home" role="tabpanel" aria-labelledby="home-tab">
                        <table class="table table-striped caption-top w-100">
                            <caption>List of users</caption>
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>e-mail</th>
                                <th>First name</th>
                                <th>Last name</th>
                                <th>Age</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Итерация по списку пользователей и вывод информации -->
                            <tr th:each="user : ${users}">
                                <td th:text="${user.id}"></td>
                                <td th:text="${user.email}"></td>
                                <td th:text="${user.firstName}"></td>
                                <td th:text="${user.lastName}"></td>
                                <td th:text="${user.age}"></td>
                                <td>
                                  <span th:each="role, iterStat : ${user.userRolesList}">
                                    <span th:text="${role.name}"></span>
                                      <!-- Добавляем запятую, если это не последний элемент -->
                                    <span th:if="${!iterStat.last}">, </span>
                                  </span>
                                </td>

                                <td>
                                    <a href="#" class="btn btn-primary" data-bs-toggle="modal"
                                       data-bs-target="#editUserModal"
                                       th:data-user-id="${user.id}"
                                       th:data-user-firstname="${user.firstName}"
                                       th:data-user-lastname="${user.lastName}"
                                       th:data-user-age="${user.age}"
                                       th:data-user-email="${user.email}"
                                       th:data-user-password="${user.password}"
                                       th:data-user-roles="${user.userRolesList}"
                                    >Edit</a>
                                    <a href="#" class="btn btn-danger" data-bs-toggle="modal"
                                       data-bs-target="#deleteUserModal"
                                       th:data-user-id="${user.id}"
                                       th:data-user-firstname="${user.firstName}"
                                       th:data-user-lastname="${user.lastName}"
                                       th:data-user-age="${user.age}"
                                       th:data-user-email="${user.email}"
                                    >Delete</a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel"
                             aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="edit-user-form" th:action="@{/edit/{id}(id=__userId__)}"
                                              method="post" th:object="${user}">
                                            <input type="hidden" th:name="${_csrf.parameterName}"
                                                   th:value="${_csrf.token}">
                                            <input type="hidden" id="editUserId" name="userId" th:value="0"/>
                                            <div class="mb-3">
                                                <label for="editFirstName" class="form-label">First Name:</label>
                                                <input class="form-control" type="text" id="editFirstName"
                                                       name="firstName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="editLastName" class="form-label">Last Name:</label>
                                                <input class="form-control" type="text" id="editLastName"
                                                       name="lastName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="editAge" class="form-label">Age:</label>
                                                <input class="form-control" type="number" id="editAge" name="age"
                                                       required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="editEmail" class="form-label">Email:</label>
                                                <input class="form-control" type="text" id="editEmail" name="email"
                                                       required>
                                            </div>
                                            <div class="md-3">
                                                <label for="editPassword" class="form-label">Password:</label>
                                                <input class="form-control" type="password" id="editPassword"
                                                       name="password" required>
                                            </div>

                                            <div class="md-3">
                                                <label for="editRoles" class="form-label">User Roles:</label>
                                                <select class="form-control" id="editRoles" name="editRoles" multiple th:field="*{userRolesList}">
                                                    <option th:each="role : ${roles}" th:value="${role.id}"
                                                            th:text="${role.name}"></option>
                                                </select>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close
                                        </button>
                                        <button type="button" class="btn btn-primary" id="saveEditButton">Save changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel"
                             aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="delete-user-form">
                                            <input type="hidden" id="deleteUserId" name="id">
                                            <div class="mb-3">
                                                <label for="deleteFirstName" class="form-label">First Name:</label>
                                                <input class="form-control" type="text" id="deleteFirstName" name="firstName" disabled>
                                            </div>
                                            <div class="mb-3">
                                                <label for="deleteLastName" class="form-label">Last Name:</label>
                                                <input class="form-control" type="text" id="deleteLastName" name="lastName" disabled>
                                            </div>
                                            <div class="mb-3">
                                                <label for="deleteAge" class="form-label">Age:</label>
                                                <input class="form-control" type="number" id="deleteAge" name="age" disabled>
                                            </div>
                                            <div class="mb-3">
                                                <label for="deleteEmail" class="form-label">Email:</label>
                                                <input class="form-control" type="text" id="deleteEmail" name="email" disabled>
                                            </div>
                                            <div class="mb-3">
                                                <label for="deleteRoles" class="form-label">User Roles:</label>
                                                <select class="form-control" id="deleteRoles" name="deleteRoles" multiple disabled>
                                                    <!-- Опции ролей будут добавлены через JavaScript -->
                                                </select>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-danger" id="deleteUserButton">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="tab-pane" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        <h3>
                            Create new user
                        </h3>
                        <div class="container">
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <form id="new-user-form" action="/new" method="post" th:object="${user}">
                                        <div class="mb-3">
                                            <label for="firstName" class="form-label">First Name:</label>
                                            <input class="form-control" type="text" id="firstName" name="firstName"
                                                   th:value="${user.firstName}" required>
                                        </div>

                                        <div class="md-3">
                                            <label for="lastName" class="form-label">Last Name:</label>
                                            <input class="form-control" type="text" id="lastName" name="lastName"
                                                   th:value="${user.lastName}" required>
                                        </div>

                                        <div class="md-3">

                                            <label for="age" class="form-label">Age:</label>
                                            <input class="form-control" type="number" id="age" name="age"
                                                   th:value="${user.age}" required>
                                        </div>

                                        <div class="md-3">
                                            <label for="email" class="form-label">Email:</label>
                                            <input class="form-control" type="text" id="email" name="email"
                                                   th:value="${user.email}" required>
                                        </div>

                                        <div class="md-3">
                                            <label for="password" class="form-label">Password:</label>
                                            <input class="form-control" type="password" id="password" name="password"
                                                   th:value="${user.password}" required>
                                        </div>

                                        <div class="md-3">
                                            <label for="userRoles" class="form-label">User Roles:</label>
                                            <select class="form-control" id="userRoles" name="userRoles" multiple
                                                    th:field="*{userRolesList}">
                                                <option th:each="role : ${roles}" th:value="${role.id}"
                                                        th:text="${role.name}"></option>
                                            </select>
                                        </div>

                                        <input th:name="${_csrf.parameterName}" type="hidden"
                                               th:value="${_csrf.token}"/>
                                        <div id="success-message" class="success-message" style="color: green; display: none;">User added successfully!</div>
                                        <div id="error-message" class="error-message" style="color: red;"></div>
                                        <input type="submit" class="btn btn-primary" value="Create User">
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User panel content -->
            <div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel"
                 aria-labelledby="v-pills-profile-tab">
                <h2 class="mx-2 my-2">
                    User information page
                </h2>
                <div th:object="${currentUser}">
                    <table class="table table-striped w-100 mx-2 my-2">
                        <caption>Your personal info</caption>
                        <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">First name</th>
                            <th scope="col">Last name</th>
                            <th scope="col">Age</th>
                            <th scope="col">Email</th>
                            <th scope="col">Role</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr>
                            <td><span th:text="${currentUser.id}"></span></td>
                            <td><span th:text="${currentUser.firstName}"></span></td>
                            <td><span th:text="${currentUser.lastName}"></span></td>
                            <td><span th:text="${currentUser.age}"></span></td>
                            <td><span th:text="${currentUser.email}"></span></td>
                            <td>
                              <span th:each="role, iterStat : ${currentUser.userRolesList}">
                                <span th:text="${role.name}"></span>
                                  <!-- Добавляем запятую, если это не последний элемент -->
                                <span th:if="${!iterStat.last}">, </span>
                              </span>
                            </td>
                        </tr>
                        </tbody>

                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("#new-user-form");
        const errorMessage = document.querySelector("#error-message");
        const successMessage = document.querySelector("#success-message");

        form.addEventListener("submit", function (event) {
            event.preventDefault();

            const formData = new FormData(form);

            fetch(form.action, {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        errorMessage.textContent = data.error;
                        errorMessage.style.display = "block";
                        successMessage.style.display = "none";
                    } else {
                        errorMessage.style.display = "none";
                        form.reset(); // Очистка полей формы
                        successMessage.style.display = "block"; // Показ сообщения об успешной отправке
                    }
                });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const editUserModal = document.querySelector("#editUserModal");
        const editUserForm = document.querySelector("#edit-user-form");
        const saveEditButton = document.querySelector("#saveEditButton");
        const userIdInput = document.querySelector("#editUserId");

        editUserModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute("data-user-id");
            const userFirstName = button.getAttribute("data-user-firstname");
            const userLastName = button.getAttribute("data-user-lastname");
            const userAge = button.getAttribute("data-user-age");
            const userEmail = button.getAttribute("data-user-email");
            const userPassword = button.getAttribute("data-user-password");
            const userRoles = button.getAttribute("data-user-roles");

            userIdInput.value = userId;  // Присваиваем значение userIdInput
            document.querySelector("#editFirstName").value = userFirstName;
            document.querySelector("#editLastName").value = userLastName;
            document.querySelector("#editAge").value = userAge;
            document.querySelector("#editEmail").value = userEmail;
            document.querySelector("#editPassword").value = userPassword;
            // Разбиваем строку с ролями на массив
            const userRolesArray = userRoles.split(",");

            // Получаем элемент select
            const editRolesSelect = document.querySelector("#editRoles");

            // Устанавливаем атрибут selected для соответствующих опций в select
            userRolesArray.forEach(roleId => {
                const option = editRolesSelect.querySelector(`option[value="${roleId.trim()}"]`);
                if (option) {
                    option.setAttribute("selected", "selected");
                }
            });
        });

        saveEditButton.addEventListener("click", function () {
            editUserForm.action = "/edit/" + userIdInput.value;
            editUserForm.submit();
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const deleteUserModal = document.querySelector("#deleteUserModal");
        const deleteUserForm = document.querySelector("#delete-user-form");
        const deleteUserButton = document.querySelector("#deleteUserButton");
        const deleteRolesSelect = deleteUserForm.querySelector("#deleteRoles");

        deleteUserModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute("data-user-id");
            const userFirstName = button.getAttribute("data-user-firstname");
            const userLastName = button.getAttribute("data-user-lastname");
            const userAge = button.getAttribute("data-user-age");
            const userEmail = button.getAttribute("data-user-email");
            const userRoles = button.getAttribute("data-user-roles");

            const deleteUserIdInput = deleteUserForm.querySelector("#deleteUserId");
            const deleteFirstNameInput = deleteUserForm.querySelector("#deleteFirstName");
            const deleteLastNameInput = deleteUserForm.querySelector("#deleteLastName");
            const deleteAgeInput = deleteUserForm.querySelector("#deleteAge");
            const deleteEmailInput = deleteUserForm.querySelector("#deleteEmail");

            deleteUserIdInput.value = userId;
            deleteFirstNameInput.value = userFirstName;
            deleteLastNameInput.value = userLastName;
            deleteAgeInput.value = userAge;
            deleteEmailInput.value = userEmail;

            // Splitting the role IDs into an array and selecting options
            const rolesArray = userRoles.split(",");
            for (const option of deleteRolesSelect.options) {
                option.selected = rolesArray.includes(option.value);
            }
        });

        deleteUserButton.addEventListener("click", function () {
            deleteUserForm.action = "/delete/" + deleteUserForm.querySelector("#deleteUserId").value;
            deleteUserForm.submit();
        });
    });
</script>




</body>
</html>